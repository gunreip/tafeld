name: Playwright E2E

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]
    workflow_dispatch:

jobs:
    e2e:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  coverage: none
                  extensions: mbstring, pdo, pdo_sqlite

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Composer deps
              run: composer install --no-progress --no-suggest --prefer-dist

            - name: Prepare env
              run: |
                  cp .env.example .env
                  php artisan key:generate --ansi
                  mkdir -p database && touch database/testing.sqlite
                  # Ensure .env uses sqlite for CI
                  php -r "file_put_contents('.env', str_replace(['DB_CONNECTION=mysql','DB_DATABASE=laravel'], ['DB_CONNECTION=sqlite','DB_DATABASE=database/testing.sqlite'], file_get_contents('.env')));"
                  # Ensure DB_DATABASE is explicitly set (replace if present, append if missing)
                  if grep -q '^DB_DATABASE=' .env; then sed -i 's#^DB_DATABASE=.*#DB_DATABASE=database/testing.sqlite#' .env; else echo 'DB_DATABASE=database/testing.sqlite' >> .env; fi
                  # Ensure APP_ENV is set to testing (replace if present, append if missing)
                  if grep -q '^APP_ENV=' .env; then sed -i 's/^APP_ENV=.*/APP_ENV=testing/' .env; else echo 'APP_ENV=testing' >> .env; fi
                  # Ensure debug UI feature flag is enabled
                  if grep -q '^TAFELD_DEBUG_UI_ENABLED=' .env; then sed -i 's/^TAFELD_DEBUG_UI_ENABLED=.*/TAFELD_DEBUG_UI_ENABLED=true/' .env; else echo 'TAFELD_DEBUG_UI_ENABLED=true' >> .env; fi
              env:
                  APP_ENV: testing

            - name: Run migrations
              run: |
                  php artisan migrate --force
                  # Ensure an admin user exists for E2E login attempts
                  php artisan db:seed --class=AdminSeeder --force || true
              env:
                  APP_ENV: testing
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
                  TAFELD_DEBUG_UI_ENABLED: "true"

            - name: Install Node deps
              run: |
                  npm ci || npm install

            - name: Build assets
              run: npm run build

            - name: Install Playwright browsers
              run: npx playwright install --with-deps

            - name: Start Laravel server
              env:
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
              run: nohup php artisan serve --host 127.0.0.1 --port 8000 > /tmp/laravel.log 2>&1 &

            - name: Server start diagnostics
              run: |
                  # Give the server a moment to bind
                  sleep 1

                  echo "=== ENV from getenv() ===" > /tmp/server_start_diagnostics
                  php -r 'echo "APP_ENV=" . (getenv("APP_ENV")?:"(unset)") ."\n"; echo "DB_CONNECTION=" . (getenv("DB_CONNECTION")?:"(unset)") ."\n"; echo "DB_DATABASE=" . (getenv("DB_DATABASE")?:"(unset)") ."\n";' >> /tmp/server_start_diagnostics || true

                  echo "=== php artisan env ===" >> /tmp/server_start_diagnostics
                  php artisan env >> /tmp/server_start_diagnostics 2>&1 || true

                  echo "=== php artisan route:list (grep _debug_test) ===" >> /tmp/server_start_diagnostics
                  php artisan route:list 2>&1 | sed -n '1,200p' >> /tmp/server_start_diagnostics || true

                  echo "=== grep in route files ===" >> /tmp/server_start_diagnostics
                  grep -nR "_debug_test/overview" routes || true >> /tmp/server_start_diagnostics || true

                  echo "=== /tmp/server_start_diagnostics (first 200 lines) ==="
                  sed -n '1,200p' /tmp/server_start_diagnostics || true

            - name: Wait for server
              run: |
                  # Try up to 120s, print HTTP status and short body on failure for diagnostics
                  for i in {1..120}; do
                    curl -s -o /tmp/health_body -w '%{http_code}' "http://127.0.0.1:8000/_debug_test/overview" > /tmp/health_status 2>/tmp/health_err || true
                    status=$(cat /tmp/health_status || echo "000")
                    echo "Attempt $i - HTTP $status"
                    if [ "$status" = "200" ]; then
                      echo "Server is up"; exit 0;
                    fi
                    if [ -s /tmp/health_body ]; then
                      echo "Body preview (first 10 lines):"; head -n 10 /tmp/health_body | sed -n '1,10p'
                    fi
                    if [ -s /tmp/health_err ]; then
                      echo "Curl error (stderr):"; sed -n '1,20p' /tmp/health_err
                    fi
                    echo "Waiting for server... ($i/120)"; sleep 1;
                  done
                  echo "Server did not respond within timeout. Showing last lines of /tmp/laravel.log:";
                  echo "---- /tmp/laravel.log (last 500 lines) ----";
                  tail -n 500 /tmp/laravel.log || true;
                  echo "---- end /tmp/laravel.log ----";
                  echo "---- Last health check body (if any) ----";
                  sed -n '1,200p' /tmp/health_body || true;
                  echo "---- curl stderr (if any) ----";
                  sed -n '1,200p' /tmp/health_err || true;
                  exit 1;

            - name: Run Playwright tests
              run: npx playwright test --reporter=list
              env:
                  BASE_URL: http://127.0.0.1:8000
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite

            - name: Run login screenshot script (always)
              if: always()
              run: |
                  echo "Running login screenshot script to capture show/hide behavior"
                  node scripts/screenshot-login-show-password.js
              env:
                  BASE_URL: http://127.0.0.1:8000
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
                  # Optionally set secrets for credentials; fallbacks are used in script
                  E2E_USER: ${{ secrets.E2E_USER }}
                  E2E_PASS: ${{ secrets.E2E_PASS }}
                  PLAYWRIGHT_STORAGE: ./playwright-storage/auth.json

            - name: Run debug logs screenshot script (always)
              if: always()
              run: |
                  echo "Running screenshot script to capture debug page states"
                  node scripts/screenshot-debug-logs-states.js
              env:
                  BASE_URL: http://127.0.0.1:8000
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
                  # Optionally set secrets for credentials; fallbacks are used in script
                  E2E_USER: ${{ secrets.E2E_USER }}
                  E2E_PASS: ${{ secrets.E2E_PASS }}
                  PLAYWRIGHT_STORAGE: ./playwright-storage/auth.json

            - name: Upload Playwright Artifacts (always)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-artifacts
                  path: |
                      playwright-report
                      playwright-report/**
                      ./playwright-report
                      /tmp/playwright
                      test-results
                      /tmp/laravel.log
                      /tmp/server_start_diagnostics
                      playwright-screenshots
                      playwright-screenshots/**
