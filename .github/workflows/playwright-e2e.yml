name: Playwright E2E

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]

jobs:
    e2e:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  coverage: none
                  extensions: mbstring, pdo, pdo_sqlite

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Composer deps
              run: composer install --no-progress --no-suggest --prefer-dist

            - name: Prepare env
              run: |
                  cp .env.example .env
                  php artisan key:generate --ansi
                  mkdir -p database && touch database/testing.sqlite
                  # Ensure .env uses sqlite for CI
                  php -r "file_put_contents('.env', str_replace(['DB_CONNECTION=mysql','DB_DATABASE=laravel'], ['DB_CONNECTION=sqlite','DB_DATABASE=database/testing.sqlite'], file_get_contents('.env')));"
                  # Ensure DB_DATABASE is explicitly set (uncommented/added)
                  echo 'DB_DATABASE=database/testing.sqlite' >> .env
              env:
                  APP_ENV: testing

            - name: Run migrations
              run: php artisan migrate --force
              env:
                  APP_ENV: testing
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
                  TAFELD_DEBUG_UI_ENABLED: "true"

            - name: Install Node deps
              run: |
                  npm ci || npm install

            - name: Build assets
              run: npm run build

            - name: Install Playwright browsers
              run: npx playwright install --with-deps

            - name: Start Laravel server
              env:
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite
              run: nohup php artisan serve --host 127.0.0.1 --port 8000 > /tmp/laravel.log 2>&1 &

            - name: Wait for server
              run: |
                  # Try up to 120s, print HTTP status and short body on failure for diagnostics
                  for i in {1..120}; do
                    curl -s -o /tmp/health_body -w '%{http_code}' "http://127.0.0.1:8000/_debug_test/overview" > /tmp/health_status 2>/tmp/health_err || true
                    status=$(cat /tmp/health_status || echo "000")
                    echo "Attempt $i - HTTP $status"
                    if [ "$status" = "200" ]; then
                      echo "Server is up"; exit 0;
                    fi
                    if [ -s /tmp/health_body ]; then
                      echo "Body preview (first 10 lines):"; head -n 10 /tmp/health_body | sed -n '1,10p'
                    fi
                    if [ -s /tmp/health_err ]; then
                      echo "Curl error (stderr):"; sed -n '1,20p' /tmp/health_err
                    fi
                    echo "Waiting for server... ($i/120)"; sleep 1;
                  done
                  echo "Server did not respond within timeout. Showing last lines of /tmp/laravel.log:";
                  echo "---- /tmp/laravel.log (last 500 lines) ----";
                  tail -n 500 /tmp/laravel.log || true;
                  echo "---- end /tmp/laravel.log ----";
                  echo "---- Last health check body (if any) ----";
                  sed -n '1,200p' /tmp/health_body || true;
                  echo "---- curl stderr (if any) ----";
                  sed -n '1,200p' /tmp/health_err || true;
                  exit 1;

            - name: Run Playwright tests
              run: npx playwright test --reporter=list
              env:
                  BASE_URL: http://127.0.0.1:8000
                  APP_ENV: testing
                  TAFELD_DEBUG_UI_ENABLED: "true"
                  DB_CONNECTION: sqlite
                  DB_DATABASE: database/testing.sqlite

            - name: Upload Playwright Artifacts (always)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-artifacts
                  path: |
                      playwright-report
                      playwright-report/**
                      ./playwright-report
                      /tmp/playwright
                      test-results
                      /tmp/laravel.log
